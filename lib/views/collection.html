{% extends 'layout.html' %}

{% block title %}{{ collectionName }}{% endblock %}


{% block styles %}
<link href="{{ baseHref }}public/css/codemirror.css" rel="stylesheet">

{% if editorTheme != "default" %}
<link href="{{ baseHref }}public/css/theme/{{ editorTheme }}.css" rel="stylesheet">
{% endif %}

<style type="text/css">
  .CodeMirror-scroll {
    height: 120px;
    overflow: auto;
  }

  .modal-body .CodeMirror .CodeMirror-scroll {
    height: auto;
    min-height: 200px;
    overflow-y: hidden;
    overflow-x: auto;
    width: 100%;
  }

  .tab-pane > form {
    padding-bottom: 5px;
  }

  .sorting-button {
    white-space: nowrap;
  }

  @media (min-width: 992px) { /* meduim and up */
    #advanced .form-group .btn {
      height: 150px;
    }
  }

  #indexes td {
    vertical-align: middle;
  }
</style>
{% endblock %}


{% block breadcrumb %}
  <li>
    <a href="/">基本信息</a>
  </li>
  <li>
    <a href="/"><span class="glyphicon glyphicon-chevron-right"></span></a>
  </li>
  <li>
    <a href="{{ baseHref }}db/{{ dbName}}">数据库:</a>
  </li>
  <li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ dbName }}<span class="caret"></span></a>
    <ul class="dropdown-menu">
      {% for db in databases %}
      <li><a href="{{ baseHref }}db/{{ db }}/">{{ db }}</a></li>
      {% endfor %}
    </ul>
  </li>
  <li>
    <a href="{{ baseHref }}db/{{ dbName}}"><span class="glyphicon glyphicon-chevron-right"></span></a>
  </li>
  <li>
    <a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}">集合:</a>
  </li>
  <li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ collectionName }}<span class="caret"></span></a>
    <ul class="dropdown-menu">
      {% for collection in collections %}
      <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collection | url_encode }}">{{ collection }}</a></li>
      {% endfor %}
    </ul>
  </li>
{% endblock %}

{% block content %}


  <br/>
  <ul id="tabs" class="nav nav-pills nav-justified" data-tabs="tabs" style="width: 20vw;">
    <li class="active"><a href="#simple" data-toggle="tab">简单查询</a></li>
    <li><a href="#advanced" data-toggle="tab">高级查询</a></li>
  </ul>
  <div id="my-tab-content" class="tab-content">
    <div class="tab-pane active" id="simple">
      <form class="well" method="get" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}">
        {% for column in columns %}
          <input type="checkbox" name="sort[{{column}}]" class="hide sort-{{column}}" {% if sort[column] %}value="{{sort[column]}}" checked="checked"{% endif %}/>
        {% endfor %}
      <div class="row">
        <div class="form-group col-sm-6 col-md-4">
          <input style="width:100%;" class="input-medium form-control" type="text" id="key" name="key" placeholder="键" title="Key" value="{{ key }}">
        </div>
        <div class="form-group col-sm-6 col-md-4">
          <input style="width:100%;" class="input-medium form-control" type="text" id="value" name="value" placeholder="值" title="Value" value="{{ value }}">
        </div>
        <div class="form-group col-sm-6 col-md-2">
          <select name="type" class="form-control">
            <option value="S" {% if type == 'S' %}selected {% endif %}>字符串</option>
            <option value="R" {% if type == 'R' %}selected {% endif %}>正则</option>
            <option value="J" {% if type == 'J' %}selected {% endif %}>JSON, 布尔</option>
            <option value="N" {% if type == 'N' %}selected {% endif %}>数字</option>
            <option value="O" {% if type == 'O' %}selected {% endif %}>对象ID</option>
          </select>
        </div>
        <div class="form-group col-sm-6 col-md-2">
          <button type="submit" class="btn btn-primary btn-block">
            查询
          </button>
        </div>
      </div>
      </form>
    </div>
    <div class="tab-pane" id="advanced">
      <form class="well" method="get" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}">
        {% for column in columns %}
          <input type="checkbox" name="sort[{{column}}]" class="hide sort-{{column}}" {% if sort[column] %}value="{{sort[column]}}" checked="checked"{% endif %}/>
        {% endfor %}
        <div class="row">
          <div class="form-group col-sm-6 col-md-5">
            <textarea class="input-medium form-control" style="width: 100%; height: 150px" id="query" name="query" placeholder="查询" title="Query">{{ query }}</textarea>
          </div>
          <div class="form-group col-sm-6 col-md-5">
            <textarea class="input-medium form-control" style="width: 100%; height: 150px" id="projection" name="projection" placeholder="Projection" title="Projection">{{ projection }}</textarea>
          </div>
          <div class="form-group col-md-2">
            <button style="height:150px;" type="submit" class="btn btn-primary btn-block">
            查询
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <br/>


<!-- Add Document Modal -->
  <div class="modal fade" id="addDocument" role="dialog" tabindex="-1">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
    <form id="addDocumentForm" method="post" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}">

      <div class="modal-header">
        <button class="close" data-dismiss="modal">×</button>
        <h2>创建文档</h2>
      </div>
      <div class="modal-body" id = "document-modal-body">
        <textarea id="document" name="document">{
        "_id": ObjectID()
}</textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-error" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-success" onclick="return checkValidJSON()">
          <span class="glyphicon glyphicon-pencil"></span>
          创建
        </button>
      </div>

    </form>
    </div>
    </div>
  </div>
<!-- End Add Document Modal -->

<!-- Add Index Modal -->
<div class="modal fade" id="addIndex" role="dialog" tabindex="-1">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
    <form id="addIndexForm" method="post" action="{{ baseHref }}db/{{ dbName }}/addIndex/{{ collectionName | url_encode }}">

      <div class="modal-header">
        <button class="close" data-dismiss="modal">×</button>
        <h2>添加索引</h2>
        <!-- <span>
          A document that contains the field and value pairs where the field
          is the index key. 1 for an ascending and -1 for a descending index.
        </span> -->
      </div>
      <div class="modal-body" id = "index-modal-body">
        <textarea id="index" name="index">{
        "key": 1
}</textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-error" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-success" onclick="return checkValidIndexJSON()">
             <span class="glyphicon glyphicon-pencil"></span>
          添加
        </button>
      </div>

    </form>
    </div>
    </div>
  </div>
<!-- End Add Index Modal -->


  {% if documents.length == 0 %}
    <p class="well">
      没有符合条件的文档
    </p>
  {% else %}

  {% if pagination %}
    <ul class="pager span7">
      <li class="previous{% if prev.skip < 0 %} disabled{% endif %}">
      <a{% if prev.skip >= 0 %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip=0&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}"{% endif %}>&larr; 第一页</a>
      </li>

      <li{% if prev.skip < 0 %} class="disabled"{% endif %}>
      <a{% if prev.skip >= 0 %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ prev.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}"{% endif %}>&larr; 前一页</a>
      </li>

      <li{% if next.skip >= stats.count %} class="disabled"{% endif %}>
      <a{% if next.skip < stats.count %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ next.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}"{% endif %}>下一页 &rarr;</a>
      </li>

      <li class="next{% if next.skip >= stats.count %} disabled{% endif %}">
      <a{% if next.skip < stats.count %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ last }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}"{% endif %}>最后一页 &rarr;</a>
      </li>
    </ul>
  {% endif %}

  <div class="fadeToWhite" id="fadeToWhiteID"></div>
  <div class="table-responsive tableWrapper">
    <table class="table table-striped tableHeaderFooterBars">
      <thead>
        {% for column in columns %}
          <th class="sorting-button" data-column="{{column}}" data-direction="{{sort[column]}}" title="Sort by {{column}}">
            {{column}}
            {% if sort[column] == 1 %}
              <span class="glyphicon glyphicon-triangle-top"></span>
            {% elseif sort[column] == -1 %}
              <span class="glyphicon glyphicon-triangle-bottom"></span>
            {% endif %}
          </th>
        {% endfor %}
      </thead>
      {% for document in docs %}
        <tr onclick="loadDocument('{{ document._id | json | safe | url_encode }}')">
          {% for column in columns %}
            <td><div class="tableContent" style="">
            {{ document[column] | stringDocIDs | to_display | safe }}
            {% if !settings.read_only && column === '_id' && collectionName !== 'system.indexes' %}
              <form class="deleteButtonDocument" method="POST" style="display:inline;" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}/{{ document._id | json | safe | url_encode }}?skip={{ skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">
              <input type="hidden" name="_method" value="delete">
              <button type="submit" class="btn btn-danger">
              <span class="glyphicon glyphicon-trash"></span>
              </button>
              </form>
            {% endif %}
            </div></td>
          {% endfor %}
        </tr>
      {% endfor %}
    </table>
  </div>

  {% if pagination %}
    <nav>
      <div class="text-center">
      <ul class="pagination">
        {%- if prev2.skip >= 0 %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ prev2.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}">{{ prev2.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {%- endif %}

        {%- if prev.skip >= 0 %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ prev.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}">{{ prev.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {%- endif %}

        <li class="active"><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}">{{ here }}</a></li>

        {%- if next.skip < stats.count %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ next.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}">{{ next.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {% endif %}

        {%- if next2.skip < stats.count %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?skip={{ next2.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}{% for k, v in sort %}&sort[{{ k }}]={{ v }}{% endfor %}">{{ next2.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {% endif %}
      </ul>
      </div>
    </nav>
  {% endif %}

  {% endif %}

  {# <br/>
  {% if !settings.read_only && count > 0 %}
  <p>
    <form id="deleteListForm" method="POST" style="display:inline;" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}?key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection={{ projection }}">
      <input type="hidden" name="_method" value="delete">
      <button type="button" data-toggle="modal" data-target="#deleteListModal" class="btn btn-danger btn-large btn-block">
        删除 {{count}} documents retrieved
      </button>
    </form>
  </p>
  {% endif %}
  <br/> #}

  <div class="row">
    {% if !settings.read_only %}
      <div class="col-md-12">
        <h2>集合操作</h2>
        <form method="POST" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}" class="well form-inline">
          <input type="hidden" name="_method" value="put">
          <div class="form-group">
            <span class="add-on">{{ dbName }} . </span>
            <input class="form-control" type="text" id="collection" name="collection" placeholder="{{ collectionName }}">
          </div>
          <button type="submit" class="btn btn-primary">
            重命名
          </button>
          <button type="button" data-toggle="modal" data-target="#addDocument" class="btn btn-primary btn-large">
            创建文档
          </button>
          <button type="button" data-toggle="modal" data-target="#addIndex" class="btn btn-primary btn-large">
            添加索引
          </button>
          <a href="{{ baseHref }}db/{{ dbName }}/export/{{ collectionName | url_encode }}" class="btn btn-primary">
            导出标准格式
          </a>
          <a href="{{ baseHref }}db/{{ dbName }}/expArr/{{ collectionName | url_encode }}" class="btn btn-primary">
            导出jsonArray格式
          </a>
          <a href="{{ baseHref }}db/{{ dbName }}/expCsv/{{ collectionName | url_encode }}" class="btn btn-primary">
            导出csv格式
          </a>
          <a href="{{ baseHref }}db/{{ dbName }}/reIndex/{{ collectionName | url_encode }}" class="btn btn-primary">
            重新索引
          </a>
          <a href="{{ baseHref }}db/{{ dbName }}/compact/{{ collectionName | url_encode }}" class="btn btn-danger">
            压缩
          </a>
          {% if !settings.read_only && count > 0 %}
            <button type="button" data-toggle="modal" data-target="#deleteListModal" class="btn btn-danger btn-large">
              删除全部文档
            </button>
          {% endif %}
        </form>
      </div>
    {% endif %}

  </div>

  {# <h2>工具</h2>
  <div class="row">
    <div class="col-sm-6 {% if !settings.read_only %}col-lg-3{% endif %}">
      <div class="well">
      <a href="{{ baseHref }}db/{{ dbName }}/export/{{ collectionName | url_encode }}" class="btn btn-warning btn-block">
        导出标准格式
      </a>
      </div>
    </div>

    <div class="col-sm-6 {% if !settings.read_only %}col-lg-3{% endif %}">
      <div class="well">
      <a href="{{ baseHref }}db/{{ dbName }}/expArr/{{ collectionName | url_encode }}" class="btn btn-warning btn-block">
        导出jsonArray格式
      </a>
      </div>
    </div>

    <div class="col-sm-6 {% if !settings.read_only %}col-lg-3{% endif %}">
      <div class="well">
      <a href="{{ baseHref }}db/{{ dbName }}/expCsv/{{ collectionName | url_encode }}" class="btn btn-warning btn-block">
        导出csv格式
      </a>
      </div>
    </div>

    <div class="col-sm-6 {% if !settings.read_only %}col-lg-3{% endif %}">
      <div class="well">
      <a href="{{ baseHref }}db/{{ dbName }}/reIndex/{{ collectionName | url_encode }}" class="btn btn-warning btn-block">
        重新索引
      </a>
      </div>
    </div>

    {% if !settings.read_only %}
      <div class="col-sm-6 col-lg-3">
        <div class="well">
          <a href="{{ baseHref }}db/{{ dbName }}/compact/{{ collectionName | url_encode }}" class="btn btn-danger btn-block">
            压缩
          </a>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <form method="POST" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName | url_encode }}" id="db-{{ dbName }}-{{ collectionName }}" class="well">
          <input type="hidden" name="_method" value="delete">
          <input type="submit" class="hidden" />
          <button class="btn btn-danger deleteButtonCollection btn-block" collection-name="{{ collectionName }}" childof="db-{{ dbName }}-{{ collectionName }}">
            删除集合
          </button>
        </form>

      </div>

      <div id="confirm-deletion-document" class="modal fade" role="dialog" aria-labelledby="confirmDeletionDocumentLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              确定?
            </div>
            <div class="modal-footer">
              <button type="button" data-dismiss="modal" class="btn btn-danger" id="delete">删除</button>
              <button type="button" data-dismiss="modal" class="btn">取消</button>
            </div>
          </div>
        </div>
      </div>

      <div id="deleteListModal" class="modal fade" role="dialog" aria-labelledby="confirmDeletionListLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              Are you sure you want to delete all {{count}} documents?
            </div>
            <div class="modal-footer">
              <button type="button" data-dismiss="modal" class="btn btn-danger" id="deleteListConfirmButton">删除</button>
              <button type="button" data-dismiss="modal" class="btn">取消</button>
            </div>
          </div>
        </div>
      </div>


      <div id="confirm-deletion-collection" class="modal fade" role="dialog" aria-labelledby="confirmDeletionCollectionLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">删除集合</h4>
            </div>
            <div class="modal-body">
              <p>
                注意！你将要删除整个 <strong><span id="modal-collection-name"></span></strong> 集合.
              </p>
              <p>
                <label for="confirmation-input">请输入你要删除集合的名称</label>
                <input type="text" id="confirmation-input" name="confirmation-input" shouldbe="" value="" />
              </p>
            </div>

            <div class="modal-footer">
              <button type="button" data-dismiss="modal" class="btn btn-danger" id="delete">Delete</button>
              <button type="button" data-dismiss="modal" class="btn">Cancel</button>
            </div>

          </div>
        </div>
      </div>
    {% endif %} #}

  <div class="stats col-md-12">
    <h2>集合状态</h2>
    <table class="table table-bordered table-striped">
      <tr>
        <td>
          <strong>文档数</strong>
        </td>
        <td>
          {{ stats.count }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>总文档大小</strong>
        </td>
        <td>
          {{ stats.size|convertBytes }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>平均文档大小</strong>
        </td>
        <td>
          {{ stats.avgObjSize|convertBytes }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>Pre-allocated size</strong>
        </td>
        <td>
          {{ stats.storageSize|convertBytes }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>索引数</strong>
        </td>
        <td>
          {{ stats.nindexes }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>总索引大小</strong>
        </td>
        <td>
          {{ stats.totalIndexSize|convertBytes }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>Padding factor</strong>
        </td>
        <td>
          {{ stats.paddingFactor }}
        </td>
      </tr>
      <tr>
        <td>
          <strong>Extents</strong>
        </td>
        <td>
          {{ stats.numExtents }}
        </td>
      </tr>
    </table>
  </div>

  <div class="col-md-12">
    <h2>索引</h2>
    <table id="indexes" class="table table-bordered table-striped">
      <tr>
        <th>名称</th>
        <th>列名</th>
        <th>大小</th>
        <th>属性</th>
        <th>操作</th>
      </tr>
    {% for index in indexes %}
      <tr>
        <td>
          {{ index.name }}
        </td>
        <td>
          {% for sort in index.key %}
          <div>{{ loop.key }} &nbsp; {% if sort == 1 %} ASC {% else %} DSC {% endif %}</div>
          {% endfor %}
        </td>
        <td>
          {{ index.size|convertBytes }}
        </td>
        <td>
          {% for k,v in index %}
          <div>{% if k != 'key' && k != 'v' && k != 'name' && k != 'ns' && k != 'size'%} {{ k }}: &nbsp;{{ v }} {% endif %}</div>
          {% endfor %}
        </td>
      {% if !settings.read_only %}
        <td>
          <a class="operation" href="{{ baseHref }}db/{{ dbName }}/dropIndex/{{ collectionName | url_encode }}?name={{ index.name }}" style="justify-content: flex-start">
             删除
          </a>
        </td>
      {% else %}
        <td>
        </td>
      {% endif %}
      </tr>
    {% endfor %}
    </table>
  </div>
{% endblock %}


{% block scripts %}
<script src="{{ baseHref }}{{assets.codemirror.js}}"></script>
<script src="{{ baseHref }}{{assets.collection.js}}"></script>
{% endblock %}
